name: Build

on: 
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
      
jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        config:            
          - name: Windows 64
            os: windows-latest
            cpu: x86_64
            build-mode: SIMBA_WIN64
            binary: Simba-Win64.exe
            test: Simba-Win64.exe
            
          - name: Windows 32  
            os: windows-latest
            cpu: i386
            build-mode: SIMBA_WIN32
            binary: Simba-Win32.exe
            test: Simba-Win32.exe

          - name: Linux 64
            os: ubuntu-latest
            cpu: x86_64
            build-mode: SIMBA_LINUX64
            binary: Simba-Linux64
            test: Simba-Linux64
          
          - name: AArch64  
            os: ubuntu-latest
            cpu: aarch64
            build-mode: SIMBA_AARCH64
            binary: Simba-AArch64
            
          - name: MacOS 64
            os: macos-latest
            cpu: x86_64
            build-mode: SIMBA_DARWIN64
            binary: Simba-Darwin64.zip
            test: Simba-Darwin64
            
    steps:
      - uses: actions/checkout@v2.3.4
        with: 
          submodules: true
      
      - name: Install Lazarus
        uses: ollydev/setup-lazarus-fpcup@v2.1
        with:
          cpu: ${{ matrix.config.cpu }}
          laz-branch: lazarus_2_0_12
          fpc-branch: release_3_2_0
    
      - name: Build Simba
        run: |
          lazbuild --build-mode=${{ matrix.config.build-mode }} "Source/Simba/Simba.lpi"

      - name: Test Simba
        if: matrix.config.test != ''
        run: |
          export DISPLAY=:1
          Xvfb :1 &
          chmod +x ${{ matrix.config.test }}
          ./${{ matrix.config.test }} --run Tests/simba

      - name: Upload Binary 
        uses: actions/upload-artifact@v2.2.4
        with:
          path: ${{ matrix.config.binary }}

  release:
    if: github.ref == 'refs/heads/simba1400' && github.event_name == 'push' 
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v2.0.10

      - name: Update Release
        uses: Brandon-T/update-release-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          file: 'artifact/*'
          is_file_glob: true
          suffix_branch_name: true
          tag: 'autobuild'
          release_name: 'autobuild'
          release_notes: "Binaries for the most recent commit of this branch. Don't worry about the release date, it's wrong!"
          retry_count: 5
          bump_tag: true
          overwrite: true